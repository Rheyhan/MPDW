---
title: "ARCH-GACRH"
author: "Jonathan Marjono"
date: "2023-11-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Penjelasan (Sebelumnya...)
Merupakan upaya lanjutan dari analisis 1Eksplorasi.rmd, dengan mencoba ARCH-GARCH. Untuk ISTM filenya terpisah dengan bahasa python.

# Library
```{r}
library(readxl)
library(openxlsx)
library(astsa)
library(dynlm) #Time series regression 
library(broom) #LM test, table presentations
library(FinTS) #For ARCH test
library(forecast)
library(tseries)
library(TTR)
library(TSA)
library(graphics)
library(portes)
library(tseries) #For unit root test
library(car) #For robust standard errors
library(rugarch) #For Garch Models
library(vars) #For using VAR
library(nlWaldTest) # For testing non-linear wald test
library(lmtest) #For BP test
library(ggplot2)
library(tsibble)
library(tseries)
library(MASS)
library(forecast)
library(aTSA)
library(grid)
library(gridExtra)
library(magrittr)
library(knitr)
library(sandwich)
library(tsbox)
library(stats)
library(zoo)
library(vrtest)
library(fGarch)
library(aTSA)
library(FinTS) 
library(lmtest)
library(forecast)
library(TSA)
library(tseries)
library(xts)
library(readxl)
library(tidyverse)
```

```{r}
#Setting Theme
theme_set(theme_bw())
```

# Data
Telah diputuskan akan digunakan data rataan harian ketinggian permukaan air Ancol.
```{r}
path = "D:/Semester 5/MPDW/Project/"
df_average <- read.csv(paste(path, "Rata Harian.csv", sep=""))[,2:3]
head(df_average)
View(df_average)
```
```{r}
df_average.ts <- ts(df_average$Rataan.Ketinggian.Air.Laut)
head(df_average.ts)
```
# Plot Data Time Series
```{r}
plot(df_average.ts, type="l",
  main="Ketinggian Air 2021/01/01 - 2023/05/31", 
  xlab = "Hari ke-",
  ylab = "Rataan Ketinggian Air Laut")
```

# Memeriksa Pola Musiman
```{r}
seasonplot(df_average.ts,7,
  main="Ketinggan Air Mingguan", 
  xlab = "Hari ke-",
  ylab = "Tinggi laut (cm)", col=rainbow(18),
  year.labels=TRUE)

seasonplot(df_average.ts,30,
  main="Ketinggan Air per 30 Hari", 
  xlab = "Hari ke-",
  ylab = "Tinggi laut (cm)", col=rainbow(18),
  year.labels=TRUE)

seasonplot(df_average.ts,60,
  main="Ketinggan Air per 2 Bulan", 
  xlab = "Hari ke-",
  ylab = "Tinggi laut (cm)", col=rainbow(18),
  year.labels=TRUE)
```
Dilakukan pengujian pola musiman untuk memastikan apakah ada data yang memiliki sebuah pola musiman (seasonal). Secara plot time series dengan seasonal plot tidak ditemukan pola tertentu pada data rataan tinggi permukaan air. Oleh karena itu, dapat kita simpulkan bahwa data tidak memiliki pola musiman.

# Membagi Data (Splitting into Train-Test)
Data akan dibagi ke dalam 2 bagian yakni data training dan testing, pembagian data akan dicoba dari memberi garis pada plot untuk mencari splitting terbaik dengan cara berikut ini, namun kali ini diambil 12 bulan vs 3 bulan total 15 bulan.

Langkah sebelumnya akan diambil 15 bulan saja.
```{r}
#15 Bulan terakhir, dengan asumsi 1 bulan 30 hari saja
Bulan=15
temp=-(Bulan*30-1)+length(df_average$Rataan.Ketinggian.Air.Laut)
temp

df=df_average[temp:length(df_average$Rataan.Ketinggian.Air.Laut),]

df$Tanggal=seq(1,length(df$Rataan.Ketinggian.Air.Laut))
colnames(df)=c("periode", "rataan ketinggian air laut")
head(df)

df.ts=ts(df$`rataan ketinggian air laut`)
```

Seasonplot lagi dengan data 15*30 hari (+/- 15 bulan)
```{r}
plot(df.ts)
#points(df.ts)
abline(v=360.5, col="red", lty=3, lwd=1)

seasonplot(df.ts,30,
  main="Ketinggan Air per 30 Hari", 
  xlab = "Hari ke-",
  ylab = "Tinggi laut (cm)", col=rainbow(18),
  year.labels=TRUE)
```

Menentukan plot train test
```{r}
plot(df.ts)
#points(df.ts)
abline(v=360.5, col="red", lty=3, lwd=1) #area training and testing
```
Pembagian 
```{r}
train=df[1:360,]
train.ts=ts(train$`rataan ketinggian air laut`)
test=df[361:length(df$`rataan ketinggian air laut`),]
test.ts=ts(test$`rataan ketinggian air laut`)
```

Plot
```{r}
par(mfrow=c(1,2))
plot(train.ts, main = "Training", type = "l", xlab = "Hari ke-", ylab = "Rataan Tinggi Permukaan Air")
plot(test.ts, main = "Testing",type = "l", xlab = "Hari ke-", ylab = "Rataan Tinggi Permukaan Air")
par(mfrow=c(1,1))

#Gabungan
ggplot() +
  geom_line(data = train, aes(x = periode, y = `rataan ketinggian air laut`, col = "Train")) +
  geom_line(data = test, aes(x = periode, y = `rataan ketinggian air laut`, col = "Test")) + labs(x = "Periode Waktu", y = "Tinggi Air", color = "Legend") +
  scale_colour_manual(name="legend:", breaks = c("Train", "Test"),
                      values = c("blue", "red")) +
  theme_bw() + theme(legend.position = "bottom", plot.caption = element_text(hjust=0.5, size=12))
```

# Uji Stasioneritas (train)
## Dalam Rataan
```{r}
#Dengan plot
acf(train.ts , lag.max=30)
```
```{r}
#Uji Formal
adf.test(train.ts)
```
Dari hasil pengujian dengan plot ACF untuk data training dapat dikatakan data belum stasioner dalam rataan dengan bentuk lag pada plot ACF yang menurun secara perlahan atau secara eksponensial namun pada uji ADF dikatakan data stasioner.

## Dalam Ragam
```{r}
#Box-Cox Plot
n = length(train.ts)
index <- seq(1:n) #Sampai periode terakhir data train
bc = boxcox(train.ts~index, lambda = seq(0,5,by=1))
#Nilai Rounded Lambda
lambda <- bc$x[which.max(bc$y)]
best.lambda = bc$x[which(bc$y==max(bc$y))]
best.lambda
#SK
bc$x[bc$y > max(bc$y) - 1/2 * qchisq(.95,1)]
```

# Penangangan Stasioneritas
## Box Cox, Diff
```{r}
box <- train.ts^2
dif_ori <- diff(box, differences = 1)
plot(dif_ori, main = "Boxcox lalu Differencing 1x", ylab = "Rataan Tinggi Permukaan Air", xlab = "Hari ke-1")

acf(dif_ori, lag.max=30)
pacf(dif_ori, lag.max=30)

adf.test(dif_ori)
```

## Diff, Box Cox
```{r}
dif_ori2 <- diff(train.ts, differences = 1)
acf(dif_ori2)

dif_ori2 <- dif_ori2^2
plot(dif_ori2, ylab = "dif2BoxCox")
acf(dif_ori2)
pacf(dif_ori2)
```

# Model Tentatif
Telah diketahui sebelumnya serta disepakati akan di test yang boxcox baru differencing atau dif_ori.
```{r}
acf(dif_ori, lag.max=30) #ARIMA(0,1,1)
pacf(dif_ori, lag.max=30) #ARIMA(1,1,0) ARIMA(4,1,0)
eacf(dif_ori) #ARIMA(0,1,1), ARIMA(0,1,2), ARIMA(1,1,2)
```
## ARIMA(0,1,1)
```{r}
model1.da=Arima(dif_ori, order=c(0,1,1),method="ML")
summary(model1.da) #AIC=6558.37 

lmtest::coeftest(model1.da) #Seluruh parameter signifikan
```
## ARIMA(1,1,0)
```{r}
model2.da=Arima(dif_ori, order=c(1,1,0),method="ML")
summary(model2.da) #AIC=6723.63

lmtest::coeftest(model2.da) #Seluruh parameter signifikan
```
## ARIMA(1,1,2)
```{r}
model3.da=Arima(dif_ori, order=c(1,1,2),method='ML')
summary(model3.da) #AIC=6517.9

lmtest::coeftest(model3.da) #Seluruh Parameter Signifikan
```
## ARIMA(4,1,0)
```{r}
model4.da=Arima(dif_ori, order=c(4,1,0),method='ML')
summary(model4.da) #AIC=6627.95

lmtest::coeftest(model4.da) #Seluruh parameter signifikan
```
Semua model tetatif memiliki parameter yang signifikan, maka dipilih model dengan AIC terkecil yaitu ARIMA(1,1,2).

# Overfitting
## ARIMA(2,1,2)
```{r}
model1.of <- Arima(dif_ori, order=c(2,1,2),method="ML")
summary(model1.of) #AIC=6515.84
lmtest::coeftest(model1.of) #Ada parameter yang tidak signifikan
```

## ARIMA(1,1,3)
```{r}
model2.of <- Arima(dif_ori, order=c(1,1,3),method="ML")
summary(model2.of) #AIC=6513.64 

#Signifikansi koefisien
lmtest::coeftest(model2.of) #Seluruh parameter signifikan
tsdiag(model2.of) #sisaan terlihat acak dan bebas
checkresiduals(model2.of)
autoplot(model2.of) #model tidak stable, ada titik yang diluar
```
Akan digunakan dengan model ARIMA(1,1,3), dengan seluruh parameter signifikan serta merupakan model terbaik dengan nilai AIC terkecil sebesar 6513.64.

## Auto ARIMA
```{r}
?auto.arima
model5.da = auto.arima(train.ts^2, trace=T, d=1)
summary(model5.da) #AIC=6518.95 

lmtest::coeftest(model5.da) #Seluruh parameter signifikan
```

## ARIMA(2,1,1)
```{r}
model6.da=Arima(dif_ori, order=c(2,1,1),method='ML')
summary(model6.da) #AIC=6530.08  

lmtest::coeftest(model6.da) #ada parameter yang tidak signifikan
```
# Diagnostik Model
```{r}
#Eksplorasi dengan plot
sisaan.da <- model2.of$residuals 
par(mfrow=c(2,2)) 
qqnorm(sisaan.da) 
qqline(sisaan.da, col = "blue", lwd = 2) 
plot(c(1:length(sisaan.da)),sisaan.da) 
acf(sisaan.da) 
pacf(sisaan.da) 
par(mfrow = c(1,1))
```

```{r}
#Uji Formal
#1) Sisaan Menyebar Normal
shapiro.test(sisaan.da)
ks.test(sisaan.da,"pnorm")
jarque.bera.test(sisaan.da) #tak tolak H0 > sisaan menyebar normal

#2) Sisaan saling bebas/tidak ada autokorelasi
Box.test(sisaan.da, type = "Ljung")  #tak tolak H0 > sisaan saling bebas

#3) Sisaan homogen
Box.test((sisaan.da)^2, type = "Ljung")  #tak tolak H0 > sisaan homogen

#4) Nilai tengah sisaan sama dengan nol
t.test(sisaan.da, mu = 0, conf.level = 0.95)  #tak tolak h0 > nilai tengah sisaan sama dengan 0

McLeod.Li.test(y=sisaan.da)
```
$H_0$ : Sisaan menyebar normal
$H_1$ : Sisaan tidak menyebar normal
Tolak, Sisaan tidak menyebar normal (terlanggar)

$H_0$ : Sisaan saling bebas
$H_1$ : Sisaan tidak tidak saling bebas
Tak tolak, Sisaan saling bebas (terpenuhi)

$H_0$ : Ragam sisaan homogen
$H_1$ : Ragam sisaan tidak homogen
Tolak, Sisaan tidak homogen (terlanggar)

$H_0$ : nilai tengah sisaan sama dengan 0
$H_1$ : nilai tengah sisaan tidak sama dengan 0
Tak tolak, Nilai tengah sisaan sama dengan nol (terpenuhi)

# Testing ARCH_GARCH
```{r}
jarque.bera.test(sisaan.da)
acf(sisaan.da^2, main = "ACF Sqared Residual")
```
Terlihat ada korelasi pada sisaan kuadrat yang menandakan terdapat heteroskedastis. Berdasarkan plot sisaaan kuadrat terdapat titik-titik yang melebihi nilai kebanyakkannya sehingga terjadi heteroskedastisitas.

# Uji sisaan mean model
```{r}
e_topi <- ts(sisaan.da)
plot.ts(e_topi)
```

```{r}
e_topisq <- ts(sisaan.da^2)
plot.ts(e_topisq)
```
```{r}
acf(e_topisq) #Apakah cut off di lag sisaan kuadrat
```
```{r}
pacf(e_topisq)
```

# Uji Efek ARCH
Tolak H0 unttuk uji LM test dari lag 1 hingga 6. Akibatnya terdapat efek ARCH jangka panjang atau GARCH.
```{r}
for (i in 1:30) {
  ArchTest <- ArchTest(sisaan.da, lags=i, demean=TRUE)
  cat("P Value LM Test lag ke", i,"adalah" , ArchTest$p.value, "\n") }
```
```{r}
#GARCH(0,1); mu tdk signifikan, sign bias tidak signifikan
garchSpec01 <- ugarchspec(
  variance.model=list(model="sGARCH",
                      garchOrder=c(0,1)),
mean.model=list(armaOrder=c(1,3)))
garchFit01 <- ugarchfit(spec=garchSpec01, data=dif_ori)
coef(garchFit01)
garchFit01
```

```{r}
#GARCH(0,2); tdk signifikan, sign bias tidak signifikan
garchSpec02 <- ugarchspec(
  variance.model=list(model="sGARCH",
                      garchOrder=c(0,2)),
mean.model=list(armaOrder=c(1,3)))
garchFit02 <- ugarchfit(spec=garchSpec02, data=dif_ori)
coef(garchFit02)
garchFit02
```
```{r}
#GARCH(0,3)
garchSpec03 <- ugarchspec(
  variance.model=list(model="sGARCH",
                      garchOrder=c(0,3)),
mean.model=list(armaOrder=c(1,3)))
garchFit03 <- ugarchfit(spec=garchSpec03, data=dif_ori)
coef(garchFit03)
garchFit03
```
Nampak dari GARCH(0,1) menuju GARCH(0,3) terus naik information criterianya.

```{r}
#GARCH(1,1); param tidak signifikan, sign bias tidak signifikan
garchSpec11 <- ugarchspec(
  variance.model=list(model="sGARCH",
                      garchOrder=c(1,1)),
mean.model=list(armaOrder=c(1,3)))
garchFit11 <- ugarchfit(spec=garchSpec11, data=dif_ori)
coef(garchFit11)
garchFit11
```
```{r}
#GARCH(1,2)
garchSpec12 <- ugarchspec(
  variance.model=list(model="sGARCH",
                      garchOrder=c(1,2)),
mean.model=list(armaOrder=c(1,3)))
garchFit12 <- ugarchfit(spec=garchSpec12, data=dif_ori)
coef(garchFit12)
garchFit12
```
```{r}
#GARCH(2,1)
garchSpec21 <- ugarchspec(
  variance.model=list(model="sGARCH",
                      garchOrder=c(2,1)),
mean.model=list(armaOrder=c(1,3)))
garchFit21 <- ugarchfit(spec=garchSpec21, data=dif_ori)
coef(garchFit21)
garchFit21
```

```{r}
#GARCH(3,1)
garchSpec31 <- ugarchspec(
  variance.model=list(model="sGARCH",
                      garchOrder=c(3,1)),
mean.model=list(armaOrder=c(1,3)))
garchFit31 <- ugarchfit(spec=garchSpec31, data=dif_ori)
coef(garchFit31)
garchFit31
```
# Uji Diagnostik GARCH(0,1)
```{r}
dif_ori.garch01 <- garch(train.ts,c(0,1))
```
```{r}
dif_origarch01 <- summary(dif_ori.garch01)
dif_origarch01
```
```{r}
#str(sbydarch)
plot(dif_ori.garch01) 
```
# Peramalan 
## Peramalan dengan Data Train
```{r}
## ramalan dari data train
ramalan_model <- forecast::forecast(model2.of,h=90)
ramalan_model
plot(ramalan_model)
data.ramalan.da <- ramalan_model$mean
```

```{r}
pt_1 = sqrt(box[length(box)])

hasil.forc.Diff <- data.ramalan.da
hasil <- diffinv(hasil.forc.Diff, differences = 1) + pt_1
#hasil <- exp(log(2*hasil+1)/2)

#has.1 sama hasilnta dengan: cumsum(c(pt_1,hasil.forc.Diff))
ts.plot(train.ts,hasil)
```

```{r}
perbandingan.da<-matrix(data=c(head(test.ts, n=90), hasil[-1]),
                     nrow = 90, ncol = 2)
colnames(perbandingan.da)<-c("Aktual","Hasil Forecast")
perbandingan.da
accuracy(ts(hasil[-1]), head(test.ts, n=90))
```

# Coba makai arima
```{r}
#Box-Cox Plot
n = length(train.ts)
index <- seq(1:n) #Sampai periode terakhir data train
bc = boxcox(train.ts~index, lambda = seq(0,5,by=1))
#Nilai Rounded Lambda
lambda <- bc$x[which.max(bc$y)]
best.lambda = bc$x[which(bc$y==max(bc$y))]
best.lambda
#SK
bc$x[bc$y > max(bc$y) - 1/2 * qchisq(.95,1)]
```
```{r}
new_train <- BoxCox(train.ts, lambda = 2)
new_train

dif_train <- diff(new_train, differences = 1)
```

```{r}
acf(dif_train) #ARIMA(0,1,1)
pacf(dif_train) #ARIMA(1,1,0)
```
```{r}
model <- stats::arima(dif_train, order=c(0,1,1), method = "ML")
lmtest::coeftest(model)
modelforecast = forecast::forecast(model, h=90)

boxinvTransform <- function(y, lambda){
  if(lambda == 0L) {exp(y)}
  else{(y*lambda +1)^(1/lambda)}
}

invdiff = diffinv(modelforecast$mean, differences = 1)
forecast_ = boxinvTransform(invdiff, 2)

model <- Arima(train.ts, order = c(0,1,1), lambda = 2)
ramalan_model <- forecast::forecast(model, h=90)
plot(ramalan_model)

data.ramalan.da <- ramalan_model$mean

pt_1 <- train.ts[12*30] #nilai akhir data latih
hasil.forc.Diff <- ramalan_model$mean
hasil <- diffinv(hasil.forc.Diff, differences = 1) + pt_1
#has.1 sama hasilnta dengan: cumsum(c(pt_1,hasil.forc.Diff))
ts.plot(train.ts,hasil)

perbandingan.da<-matrix(data=c(test.ts, data.ramalan.da), nrow = 90, ncol = 2)
colnames(perbandingan.da)<-c("Aktual","Hasil Forecast")
perbandingan.da

accuracy(ts(data.ramalan.da), test.ts)
```


# Coba pemmotongan lain
```{r}
plot(df.ts)
#points(df.ts)
abline(v=330.5, col="red", lty=3, lwd=1) #area training and testing


train2=df[1:330,]
train2.ts=ts(train2$`rataan ketinggian air laut`)
test2=df[331:length(df$`rataan ketinggian air laut`),]
test2.ts=ts(test2$`rataan ketinggian air laut`)
```

## Uji Stasioneritas
### Dalam Rataan
```{r}
#Dengan plot
acf(train2.ts , lag.max=30)
```
### Dalam Ragam
```{r}
#Box-Cox Plot
n = length(train2.ts)
index <- seq(1:n) #Sampai periode terakhir data train
bc = boxcox(train2.ts~index, lambda = seq(-2,6,by=1))
#Nilai Rounded Lambda
lambda <- bc$x[which.max(bc$y)]
best.lambda = bc$x[which(bc$y==max(bc$y))]
best.lambda
#SK
bc$x[bc$y > max(bc$y) - 1/2 * qchisq(.95,1)]
```
## Penanganan Stasioneritas
### Box -> Diff
```{r}
box <- train2.ts^4
dif_ori <- diff(box, differences = 1)
plot(dif_ori, main = "Boxcox lalu Differencing 1x", ylab = "Rataan Tinggi Permukaan Air", xlab = "Hari ke-1")

acf(dif_ori, lag.max=30)
pacf(dif_ori, lag.max=30)

adf.test(dif_ori)
```

## Model Tentatif
Telah diketahui sebelumnya serta disepakati akan di test yang boxcox baru differencing atau dif_ori.
```{r}
acf(dif_ori, lag.max=30) #ARIMA(0,1,1)
pacf(dif_ori, lag.max=30) #ARIMA(1,1,0) ARIMA(4,1,0)
eacf(dif_ori) #ARIMA(0,1,1) ARIMA(1,1,1) ARIMA(0,0,2) ARIMA(1,1,2)
```
ARIMA(0,1,1) AIC=13335.33, sig.
ARIMA(4,1,0) AIC=13405.22, sig.
ARIMA(1,1,1) AIC=13317.39, sig.
ARIMA(1,1,2) AIC=13303.97, sig.
auto ARIMA(0,1,0) AIC=13367.16
```{r}
bestmodel=Arima(dif_ori, order=c(1,1,2),method="ML")
summary(bestmodel) #AIC=

lmtest::coeftest(bestmodel) #Seluruh parameter signifikan
```
## Overfit
ARIMA(2,1,2) AIC=13302.06, sig.
ARIMA(1,1,3) AIC=13302.45, sig. 
```{r}
#ARIMA(2,1,2)
bestmodel=Arima(dif_ori, order=c(2,1,2),method="ML")
summary(bestmodel) #AIC=13302.06 

lmtest::coeftest(bestmodel) #Seluruh parameter signifikan
```
## Peramalan
## ramalan dari data train
```{r}
ramalan_model <- forecast::forecast(bestmodel,h=90)
ramalan_model
plot(ramalan_model)
data.ramalan.da <- ramalan_model$mean
```

```{r}
pt_1 = (box[length(box)])^(1/4)
pt_1 = (box^4 - 1) / 4
hasil.forc.Diff <- data.ramalan.da
hasil <- diffinv(hasil.forc.Diff, differences = 1) + pt_1
#hasil <- exp(log(2*hasil+1)/2)

#has.1 sama hasilnta dengan: cumsum(c(pt_1,hasil.forc.Diff))
ts.plot(train2.ts,hasil)
```

```{r}
perbandingan.da<-matrix(data=c(head(test2.ts, n=90), hasil[-1]),
                     nrow = 90, ncol = 2)
colnames(perbandingan.da)<-c("Aktual","Hasil Forecast")
perbandingan.da
accuracy(ts(hasil[-1]), head(test.ts, n=30))
```
