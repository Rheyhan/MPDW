```{r}
#Modules
library(readxl)
library(openxlsx)
library(astsa)
library(dynlm) #Time series regression 
library(broom) #LM test, table presentations
library(FinTS) #For ARCH test
library(forecast)
library(tseries)
library(TTR)
library(TSA)
library(graphics)
library(portes)
library(tseries) #For unit root test
library(car) #For robust standard errors
library(rugarch) #For Garch Models
library(vars) #For using VAR
library(nlWaldTest) # For testing non-linear wald test
library(lmtest) #For BP test
library(ggplot2)
library(tsibble)
library(tseries)
library(MASS)
library(forecast)
library(aTSA)
library(grid)
library(gridExtra)
library(magrittr)
library(knitr)
library(sandwich)
library(tsbox)
library(stats)
library(zoo)
library(vrtest)
library(fGarch)
library(aTSA)
library(FinTS) 
library(lmtest)
library(forecast)
library(TSA)
library(tseries)
library(xts)
library(readxl)
library(tidyverse)
```
```{r}
#Path and dataset
path = "D:/Kuliah/Semester 5/MPDW/MPDW kelompok/MPDW/"
df_average <- read.csv(paste(path, "Data/Harian/Rata Harian.csv", sep=""))[,2:3]
```
```{r}
#pakai 15 bulan
Bulan=15
temp=-(Bulan*30-1)+length(df_average$Rataan.Ketinggian.Air.Laut)
df=df_average[temp:length(df_average$Rataan.Ketinggian.Air.Laut),]
df["Tanggal"]=seq(1,length(df$Tanggal))
colnames(df)= c("Periode", "Rataan.Ketinggian.Air.Laut")
df.ts=ts(df$Rataan.Ketinggian.Air.Laut)
```
```{r}
#Train Test Split
train=df[1:360,]
train.ts=ts(train$Rataan.Ketinggian.Air.Laut)
temp=length(df$Periode)
test=df[361:temp,]
test.ts=ts(test$Rataan.Ketinggian.Air.Laut)
```


```{r}
#Plotting Train and Test
ggplot() +
  geom_line(data = test, aes(x = Periode, y = Rataan.Ketinggian.Air.Laut, col = "Test")) +
   geom_line(data = train, aes(x = Periode, y = Rataan.Ketinggian.Air.Laut, col = "Train"))+ labs(x = "Periode Waktu", y = "Tinggi Air", color = "Legend") +
  scale_colour_manual(name="legend:", breaks = c("Train", "Test"),
                      values = c("blue", "red")) +
  theme_bw() + theme(legend.position = "bottom", plot.caption = element_text(hjust=0.5, size=12))
```
#Uji stasioneritas
```{r}
#Dengan plot
acf(train.ts , lag.max=30)
```
```{r}
#Uji Formal
adf.test(train.ts)
```
#Box clox
```{r}
n = length(train.ts)
index <- seq(1:n) #Sampai periode terakhir data train
bc = boxcox(train.ts~index, lambda = seq(0,5,by=1))
#Nilai Rounded Lambda
lambda <- bc$x[which.max(bc$y)]
best.lambda = bc$x[which(bc$y==max(bc$y))]
best.lambda
#SK
bc$x[bc$y > max(bc$y) - 1/2 * qchisq(.95,1)]
```
#Penanganan
##bOX COX, DIFF
```{r}
d <- 1
diff_train_data <- diff(train.ts, differences = d)

lambda <- BoxCox.lambda(diff_train_data)
transformed_train_data <- BoxCox(train.ts, lambda)
```
#Model Terbaik
# ARIMA(1,1,3)
```{r}
model2.of <- Arima(transformed_train_data, order=c(1,1,3),method="ML")
summary(model2.of) #AIC=6513.64 

#Signifikansi koefisien
lmtest::coeftest(model2.of) #Seluruh parameter signifikan
tsdiag(model2.of) #sisaan terlihat acak dan bebas
checkresiduals(model2.of)
autoplot(model2.of) #model tidak stable, ada titik yang diluar
```
##Get predicted train and test
```{r}
train_pred <- predict(model2.of, n.ahead = length(train$Rataan.Ketinggian.Air.Laut))$pred

test_pred <- predict(model2.of, n.ahead = length(test$Rataan.Ketinggian.Air.Laut))$pred
train_pred
```

# Diagnostik Model
```{r}
#Eksplorasi dengan plot
sisaan.da <- model2.of$residuals 
par(mfrow=c(2,2)) 
qqnorm(sisaan.da) 
qqline(sisaan.da, col = "blue", lwd = 2) 
plot(c(1:length(sisaan.da)),sisaan.da) 
acf(sisaan.da) 
pacf(sisaan.da) 
par(mfrow = c(1,1))
```

```{r}
#Uji Formal
#1) Sisaan Menyebar Normal
shapiro.test(sisaan.da)
ks.test(sisaan.da,"pnorm")
jarque.bera.test(sisaan.da) #Sisaan tidak menyebar normal
  
#2) Sisaan saling bebas/tidak ada autokorelasi
Box.test(sisaan.da, type = "Ljung")  #tak tolak H0 > sisaan saling bebas

#3) Sisaan homogen
Box.test((sisaan.da)^2, type = "Ljung")  #Tolak H0 > Sisaan heterogen

#4) Nilai tengah sisaan sama dengan nol
t.test(sisaan.da, mu = 0, conf.level = 0.95)  #tak tolak h0 > nilai tengah sisaan sama dengan 0

McLeod.Li.test(y=sisaan.da)
```
$H_0$ : Sisaan menyebar normal
$H_1$ : Sisaan tidak menyebar normal
Tolak, Sisaan tidak menyebar normal (terlanggar)

$H_0$ : Sisaan saling bebas
$H_1$ : Sisaan tidak tidak saling bebas
Tak tolak, Sisaan saling bebas (terpenuhi)

$H_0$ : Ragam sisaan homogen
$H_1$ : Ragam sisaan tidak homogen
Tolak, Sisaan tidak homogen (terlanggar)

$H_0$ : nilai tengah sisaan sama dengan 0
$H_1$ : nilai tengah sisaan tidak sama dengan 0
Tak tolak, Nilai tengah sisaan sama dengan nol (terpenuhi)
```
```{r}
test_pred
```


